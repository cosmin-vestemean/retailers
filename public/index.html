<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Pet Factory Integration Portal</title>
    <meta name="description" content="Integrating Pet Factory S1 with various retailers" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/@feathersjs/client@5.0.24/dist/feathers.min.js"></script>
    <script
      src="https://cdn.socket.io/4.7.5/socket.io.min.js"
      integrity="sha384-2huaZvOR9iDzHqslqwpR87isEmrfxqyWOF7hr7BY6KG0+hVKLoEXMPUJw3ynWuhO"
      crossorigin="anonymous"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@creativebulma/bulma-tooltip@1.2.0/dist/bulma-tooltip.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma-responsive-tables@1.2.5/css/main.min.css"
    />
    <link rel="stylesheet" href="/css/sandstone.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet" />
    <style>
      @media screen and (max-width: 800px) {
        .is-responsive {
          display: block;
          width: 100%;
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
          -ms-overflow-style: -ms-autohiding-scrollbar;
          border-collapse: collapse;
          border-spacing: 0;
          border: none;
        }
        .is-responsive th,
        .is-responsive td {
          min-width: 140px;
          width: 100%;
          display: block;
          text-align: left;
          padding: 0.5em 1em;
          border: none;
        }
        .is-responsive th {
          font-weight: bold;
        }
        .is-responsive tr {
          margin-bottom: 2em;
          border-bottom: 1px solid #ddd;
          display: flex;
          flex-direction: column;
          box-shadow: rgba(10, 10, 10, 0.1) 0px 8px 16px -2px, rgba(10, 10, 10, 0.02) 0px 0px 0px 1px;
          box-sizing: border-box;
          border-radius: 0.5em;
          width: 100%;
        }
        .is-responsive thead {
          display: none;
        }
      }
      .message-header {
        font-weight: normal;
        cursor: pointer;
      }
      .operatii {
        display: flex;
        justify-content: space-between;
        margin-bottom: 1em;
      }
      pre, code {
        background-color: white;
        padding: 0.2em 0.4em;
        border-radius: 0.3em;
        white-space: pre-wrap;
        color: #333;
      }
      .xml-display {
        position: relative;
        margin: 1em 0;
        background: #f8f9fa;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }

      pre[class*="language-"] {
        margin: 0;
        padding: 1.5em;
        max-height: 400px;
        overflow: auto;
        background: #fff;
        font-size: 0.9em;
        line-height: 1.6;
        border-radius: 6px;
      }

      .line-numbers .line-numbers-rows {
        border-right: 2px solid #e9ecef;
        padding: 1em 0;
      }

      .token.tag {
        color: #2f6f9f;
      }
      .token.attr-name {
        color: #4f9fcf;
      }
      .token.attr-value {
        color: #d44950;
      }
      .token.string {
        color: #42b983;
      }
      
      /* Card styles */
      .card-selection {
        padding: 2rem 0;
      }
      
      .app-card {
        height: 100%;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        cursor: pointer;
      }
      
      .app-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      }
      
      .card-image {
        padding: 1.5rem;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      
      .back-button {
        margin-bottom: 1.5rem;
      }
      
      .construction-container {
        text-align: center;
        padding: 3rem 1.5rem;
      }
      
      .construction-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        color: #ffdd57;
      }
      
      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      /* Hide retail actions by default */
      .retail-action {
        display: none;
      }

      /* Nav context styles */
      .app-context-title {
        margin-left: 0.5rem;
        font-size: 0.8rem;
        color: #888;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <nav class="navbar is-transparent" role="navigation" aria-label="main navigation">
      <div class="navbar-brand">
        <a class="navbar-item" id="navbarBrand">
          <img
            src="https://www.petfactory.ro/wp-content/uploads/2022/06/sigla-pet-factory.ro_.png"
            width="90"
            height="28"
          />
          <span class="title is-4">Integration Portal</span>
          <span class="app-context-title" id="contextTitle"></span>
        </a>

        <a
          role="button"
          class="navbar-burger"
          aria-label="menu"
          aria-expanded="false"
          data-target="navbarMenu"
        >
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>

      <div id="navbarMenu" class="navbar-menu">
        <div class="navbar-start">
          <a class="navbar-item"> Documentation </a>

          <div class="navbar-item has-dropdown is-hoverable retail-action">
            <a class="navbar-link"> Retailer Actions </a>
            <div class="navbar-dropdown">
              <a class="navbar-item" id="preluareComenziBtn">Preluare documente</a>
              <div class="dropdown-divider"></div>
              <a class="navbar-item" id="preluareAperakBtn">Preluare raspunsuri</a>
              <a class="navbar-item" id="openAperakBtn">Vizualizare raspunsuri neprelucrate</a>
              <div class="dropdown-divider"></div>
              <a class="navbar-item" id="createOrders"> Trimite comenzile noi </a>
              <a class="navbar-item" id="scanNow"> Preluare si trimitere </a>
            </div>
          </div>

          <div class="navbar-item has-dropdown is-hoverable">
            <a class="navbar-link"> More </a>
            <div class="navbar-dropdown">
              <a class="navbar-item"> About </a>
              <a class="navbar-item"> Contact </a>
              <hr class="navbar-divider" />
              <a class="navbar-item"> Report an issue </a>
            </div>
          </div>
        </div>
      </div>
    </nav>
    
    <!-- Main card selection screen -->
    <div id="cardSelectionScreen" class="section card-selection">
      <div class="container">
        <h1 class="title is-3 has-text-centered mb-5">Select Application</h1>
        
        <div class="columns is-centered">
          <!-- Retailers Card -->
          <div class="column is-one-third">
            <div class="card app-card" id="retailersAppCard">
              <div class="card-image">
                <figure class="image is-128x128">
                  <img src="https://www.petfactory.ro/wp-content/uploads/2022/06/sigla-pet-factory.ro_.png" alt="Retailers logo">
                </figure>
              </div>
              <div class="card-content">
                <div class="content has-text-centered">
                  <h3 class="title is-4">Retailers</h3>
                  <p>Manage retailer integrations and document exchange</p>
                </div>
              </div>
              <footer class="card-footer">
                <a class="card-footer-item">Open Application</a>
              </footer>
            </div>
          </div>
          
          <!-- ABC Card -->
          <div class="column is-one-third">
            <div class="card app-card" id="abcAppCard">
              <div class="card-image">
                <figure class="image is-128x128">
                  <img src="https://www.petfactory.ro/wp-content/uploads/2022/06/sigla-pet-factory.ro_.png" alt="ABC logo">
                </figure>
              </div>
              <div class="card-content">
                <div class="content has-text-centered">
                  <h3 class="title is-4">ABC</h3>
                  <p>ABC management and configuration</p>
                </div>
              </div>
              <footer class="card-footer">
                <a class="card-footer-item">Open Application</a>
              </footer>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Retailers Section -->
    <div id="retailersSection" class="section" style="display: none;">
      <div class="container">
        <!-- Section header with back button and logs toggle -->
        <div class="section-header">
          <button id="backToCardsBtn" class="button is-light back-button">
            <span class="icon">
              <i class="fas fa-arrow-left"></i>
            </span>
            <span>Back to Applications</span>
          </button>
          
          <button id="toggleLogsBtn" class="button is-info">
            <span class="icon">
              <i class="fas fa-list"></i>
            </span>
            <span>Show Logs</span>
          </button>
        </div>
        
        <!-- Original retailers content -->
        <div id="cardsContainer" class="container has-background-white">
          <script type="module">
            import { retailers, drawRetailers } from './retailers.js'
            drawRetailers(retailers)
          </script>
        </div>
        <div id="ordersLogContainer" class="table-container" style="display: none">
          <h2 class="title is-4">Orders Log</h2>
          <table
            class="table is-bordered is-hoverable is-fullwidth is-small is-responsive"
            style="font-size: 0.8em"
          >
            <thead>
              <tr>
                <th>#</th>
                <th>MESSAGEDATE</th>
                <th>ORDERID</th>
                <th>MESSAGETEXT</th>
              </tr>
            </thead>
            <tbody id="ordersLogTable"></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- ABC Section -->
    <div id="abcSection" class="section" style="display: none;">
      <div class="container">
        <button id="backToCardsFromAbcBtn" class="button is-light back-button">
          <span class="icon">
            <i class="fas fa-arrow-left"></i>
          </span>
          <span>Back to Applications</span>
        </button>
        
        <!-- ABC Tabs Navigation -->
        <div class="tabs is-boxed mb-4">
          <ul id="abcTabs">
            <li class="is-active" data-tab="configuration"><a>Configuration</a></li>
            <li data-tab="bi"><a>Business Intelligence</a></li>
          </ul>
        </div>
        
        <!-- Configuration Tab Content -->
        <div id="configurationTab" class="tab-content">
          <div class="columns">
            <div class="column is-4">
              <div class="card">
                <header class="card-header">
                  <p class="card-header-title" id="employeeFormTitle">
                    Register New Employee
                  </p>
                  <div class="card-header-icon">
                    <button id="resetEmployeeForm" class="button is-small is-light">
                      <span class="icon">
                        <i class="fas fa-undo"></i>
                      </span>
                    </button>
                  </div>
                </header>
                <div class="card-content">
                  <div class="content">
                    <form id="employeeForm">
                      <input type="hidden" id="abcst" name="abcst">
                      
                      <div class="field">
                        <label class="label">Person</label>
                        <div class="control">
                          <div class="select is-fullwidth">
                            <select id="prsn" name="prsn" required>
                              <option value="">Select a person</option>
                            </select>
                          </div>
                        </div>
                      </div>
                      
                      <div class="field">
                        <label class="label">Code</label>
                        <div class="control">
                          <input class="input" type="text" id="code" name="code" placeholder="Employee code">
                        </div>
                        <p class="help">Optional - will use person code if empty</p>
                      </div>
                      
                      <div class="field">
                        <label class="label">Name</label>
                        <div class="control">
                          <input class="input" type="text" id="name" name="name" placeholder="Employee name">
                        </div>
                        <p class="help">Optional - will use person name if empty</p>
                      </div>
                      
                      <div class="field">
                        <label class="label">Status</label>
                        <div class="control">
                          <label class="checkbox">
                            <input type="checkbox" id="isactive" name="isactive" checked>
                            Is active
                          </label>
                        </div>
                      </div>
                      
                      <div class="field is-grouped mt-4">
                        <div class="control">
                          <button type="submit" class="button is-primary">Save</button>
                        </div>
                        <div class="control">
                          <button type="reset" class="button is-light">Reset</button>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="column is-8">
              <div class="card">
                <header class="card-header">
                  <p class="card-header-title">
                    Registered Employees
                  </p>
                  <div class="card-header-icon">
                    <button id="refreshEmployees" class="button is-small is-info">
                      <span class="icon">
                        <i class="fas fa-sync-alt"></i>
                      </span>
                    </button>
                  </div>
                </header>
                <div class="card-content">
                  <div class="content">
                    <div class="field">
                      <div class="control has-icons-left">
                        <input class="input" type="text" id="employeeSearch" placeholder="Search employees...">
                        <span class="icon is-small is-left">
                          <i class="fas fa-search"></i>
                        </span>
                      </div>
                    </div>
                    
                    <div class="table-container">
                      <table class="table is-striped is-fullwidth is-hoverable">
                        <thead>
                          <tr>
                            <th>Code</th>
                            <th>Name</th>
                            <th>Person</th>
                            <th>Status</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody id="employeeTableBody">
                          <!-- Employee data will be loaded here -->
                        </tbody>
                      </table>
                    </div>
                    
                    <div id="employeePagination" class="pagination is-centered" role="navigation" aria-label="pagination">
                      <!-- Pagination will be added here -->
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- BI Tab Content -->
        <div id="biTab" class="tab-content" style="display: none;">
          <div class="section">
            <!-- Load the ABC employee report directly in the BI tab -->
            <div id="abcEmployeeReportContainer">
              <!-- Report Header -->
              <div class="report-header has-background-primary-dark has-text-white p-4 mb-4 is-flex is-justify-content-space-between is-align-items-center" style="border-radius: 6px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div class="report-title">
                  <h3 class="title is-4 has-text-white mb-1">Raport ABC per Angajat</h3>
                  <p class="subtitle is-6 has-text-white-bis mt-0">Analiză detaliată venituri și cheltuieli</p>
                </div>
                <div class="report-info has-text-right">
                  <p id="reportDate" class="mb-2"></p>
                  <div class="field is-grouped">
                    <div class="control">
                      <div class="select is-small is-primary">
                        <select id="yearSelector" class="has-text-dark">
                          <option value="2024">2024</option>
                          <option value="2025" selected>2025</option>
                          <option value="2026">2026</option>
                        </select>
                      </div>
                    </div>
                    <div class="control">
                      <div class="select is-small is-primary">
                        <select id="periodSelector" class="has-text-dark">
                          <option value="1">Ianuarie</option>
                          <option value="2">Februarie</option>
                          <option value="3" selected>Martie</option>
                          <option value="4">Aprilie</option>
                          <option value="5">Mai</option>
                          <option value="6">Iunie</option>
                          <option value="7">Iulie</option>
                          <option value="8">August</option>
                          <option value="9">Septembrie</option>
                          <option value="10">Octombrie</option>
                          <option value="11">Noiembrie</option>
                          <option value="12">Decembrie</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Employee Info -->
              <div class="box mb-4">
                <div class="is-flex is-justify-content-space-between is-align-items-center">
                  <div class="employee-details">
                    <h2 id="employeeName" class="title is-4 mb-1">Nume Angajat</h2>
                    <p class="subtitle is-6 has-text-grey">Cod: <span id="employeeId">EMP001</span></p>
                  </div>
                  <div class="is-flex is-align-items-center">
                    <div class="select mr-4" style="min-width: 250px;">
                      <select id="employeeSelector">
                        <option value="loading">Încărcare angajați...</option>
                      </select>
                    </div>
                    <div class="employee-total has-text-primary has-text-weight-bold is-size-3" id="employeeTotal">0,00 RON</div>
                  </div>
                </div>
              </div>
              
              <!-- KPI Cards -->
              <div class="columns mb-4">
                <div class="column">
                  <div class="box has-background-white" style="border-top: 4px solid #2ecc71;">
                    <div class="has-text-grey mb-2 is-size-6">Total Venituri</div>
                    <div class="has-text-weight-bold is-size-3" id="kpiRevenue">0,00 RON</div>
                  </div>
                </div>
                <div class="column">
                  <div class="box has-background-white" style="border-top: 4px solid #e74c3c;">
                    <div class="has-text-grey mb-2 is-size-6">Total Cheltuieli</div>
                    <div class="has-text-weight-bold is-size-3" id="kpiExpenses">0,00 RON</div>
                  </div>
                </div>
                <div class="column">
                  <div class="box has-background-white" style="border-top: 4px solid #3498db;">
                    <div class="has-text-grey mb-2 is-size-6">Sold</div>
                    <div class="has-text-weight-bold is-size-3" id="kpiBalance">0,00 RON</div>
                  </div>
                </div>
                <div class="column">
                  <div class="box has-background-white" style="border-top: 4px solid #34495e;">
                    <div class="has-text-grey mb-2 is-size-6">Distribuție ABC</div>
                    <div class="is-flex is-justify-content-space-between mt-3">
                      <div class="has-text-centered" style="width: 30%;">
                        <div class="is-size-7">A</div>
                        <div class="has-text-weight-bold" id="abcDistributionA">0.0%</div>
                        <div style="height: 6px; background-color: #ecf0f1; border-radius: 3px; overflow: hidden; margin-top: 5px;">
                          <div style="height: 100%; background-color: #e74c3c;" id="abcProgressA" style="width: 0%"></div>
                        </div>
                      </div>
                      <div class="has-text-centered" style="width: 30%;">
                        <div class="is-size-7">B</div>
                        <div class="has-text-weight-bold" id="abcDistributionB">0.0%</div>
                        <div style="height: 6px; background-color: #ecf0f1; border-radius: 3px; overflow: hidden; margin-top: 5px;">
                          <div style="height: 100%; background-color: #f39c12;" id="abcProgressB" style="width: 0%"></div>
                        </div>
                      </div>
                      <div class="has-text-centered" style="width: 30%;">
                        <div class="is-size-7">C</div>
                        <div class="has-text-weight-bold" id="abcDistributionC">0.0%</div>
                        <div style="height: 6px; background-color: #ecf0f1; border-radius: 3px; overflow: hidden; margin-top: 5px;">
                          <div style="height: 100%; background-color: #2ecc71;" id="abcProgressC" style="width: 0%"></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Overview Charts -->
              <div class="columns mb-4">
                <div class="column is-6">
                  <div class="box" style="height: 300px;">
                    <h3 class="title is-5 has-text-centered mb-4">Venituri vs. Cheltuieli</h3>
                    <div style="height: calc(100% - 40px); position: relative;">
                      <canvas id="revenueExpenseChart"></canvas>
                    </div>
                  </div>
                </div>
                <div class="column is-6">
                  <div class="box" style="height: 300px;">
                    <h3 class="title is-5 has-text-centered mb-4">Distribuție ABC</h3>
                    <div style="height: calc(100% - 40px); position: relative;">
                      <canvas id="abcDistributionChart"></canvas>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Revenues Section -->
              <div class="box mb-4" id="revenuesSection">
                <div class="is-flex is-justify-content-space-between is-align-items-center p-3" style="cursor: pointer; background-color: #f8f9fa; border-radius: 6px; margin: -1.25rem -1.25rem 0 -1.25rem;">
                  <div class="is-flex is-align-items-center">
                    <span class="icon-text mr-2" style="width: 24px; height: 24px; border-radius: 50%; background-color: #3498db; color: white; display: inline-flex; justify-content: center; align-items: center; font-weight: bold;">
                      <span class="toggle-icon">+</span>
                    </span>
                    <span class="has-text-weight-semibold is-size-5">Venituri</span>
                  </div>
                  <div class="has-text-weight-bold" id="totalRevenue">0,00 RON</div>
                </div>
                <div class="section-content mt-4" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out;">
                  <div id="revenueSectionContent">
                    <!-- This will be populated dynamically -->
                  </div>
                </div>
              </div>
              
              <!-- Expenses Section -->
              <div class="box mb-4" id="expensesSection">
                <div class="is-flex is-justify-content-space-between is-align-items-center p-3" style="cursor: pointer; background-color: #f8f9fa; border-radius: 6px; margin: -1.25rem -1.25rem 0 -1.25rem;">
                  <div class="is-flex is-align-items-center">
                    <span class="icon-text mr-2" style="width: 24px; height: 24px; border-radius: 50%; background-color: #3498db; color: white; display: inline-flex; justify-content: center; align-items: center; font-weight: bold;">
                      <span class="toggle-icon">+</span>
                    </span>
                    <span class="has-text-weight-semibold is-size-5">Cheltuieli</span>
                  </div>
                  <div class="has-text-weight-bold" id="totalExpenses">0,00 RON</div>
                </div>
                <div class="section-content mt-4" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out;">
                  <div id="expensesSectionContent">
                    <!-- This will be populated dynamically -->
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Loading Overlay -->
            <div class="loading-overlay" id="loadingOverlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.8); display: none; justify-content: center; align-items: center; z-index: 1000;">
              <div class="spinner" style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            </div>
          </div>
        </div>
        
        <!-- Success/Error Notification -->
        <div id="notification" class="notification" style="display: none; position: fixed; top: 20px; right: 20px; z-index: 1000;">
          <button class="delete" onclick="this.parentElement.style.display='none'"></button>
          <span id="notificationMessage"></span>
        </div>
        
        <!-- Add notification container for BI module -->
        <div id="notification-container" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;"></div>
      </div>
    </div>
    
    <script type="module">
      import {
        getRemoteXmlListToErp,
        getRemoteAperakXmlListToErp,
        getEmptyAperak,
        createNewOrders,
        loadOrdersLog,
        scanAndSend,
      } from './client.js'
      
      // Function to update navigation context
      function updateNavigationContext(context) {
        const retailActions = document.querySelectorAll('.retail-action');
        const contextTitle = document.getElementById('contextTitle');
        
        if (context === 'retailers') {
          // Show retailer-specific actions in nav
          retailActions.forEach(el => el.style.display = 'flex');
          contextTitle.textContent = '» Retailers';
        } else if (context === 'abc') {
          // Hide retailer actions and update context
          retailActions.forEach(el => el.style.display = 'none');
          contextTitle.textContent = '» ABC';
        } else {
          // Home context, hide retailer actions
          retailActions.forEach(el => el.style.display = 'none');
          contextTitle.textContent = '';
        }
      }
      
      // Add event listeners for existing functionality
      document.getElementById('preluareComenziBtn').addEventListener('click', function () {
        getRemoteXmlListToErp();
      });
      
      document.getElementById('preluareAperakBtn').addEventListener('click', function () {
        getRemoteAperakXmlListToErp();
      });
      
      document.getElementById('openAperakBtn').addEventListener('click', function () {
        getEmptyAperak();
      });
      
      document.getElementById('createOrders').addEventListener('click', async function () {
        await createNewOrders();
      });
      
      document.getElementById('scanNow').addEventListener('click', async function () {
        await scanAndSend();
      });
      
      document.getElementById('toggleLogsBtn').addEventListener('click', function () {
        const cardsContainer = document.getElementById('cardsContainer');
        const ordersLogContainer = document.getElementById('ordersLogContainer');
        const toggleLogsBtn = document.getElementById('toggleLogsBtn');
        
        if (ordersLogContainer.style.display === 'none') {
          ordersLogContainer.style.display = 'block';
          cardsContainer.style.display = 'none';
          toggleLogsBtn.innerHTML = '<span class="icon"><i class="fas fa-th"></i></span><span>Show Cards</span>';
          loadOrdersLog();
        } else {
          ordersLogContainer.style.display = 'none';
          cardsContainer.style.display = 'block';
          toggleLogsBtn.innerHTML = '<span class="icon"><i class="fas fa-list"></i></span><span>Show Logs</span>';
        }
      });
      
      // Home navigation
      document.getElementById('navbarBrand').addEventListener('click', function() {
        document.getElementById('retailersSection').style.display = 'none';
        document.getElementById('abcSection').style.display = 'none';
        document.getElementById('cardSelectionScreen').style.display = 'block';
        updateNavigationContext('home');
      });
      
      // Navigation between sections
      document.getElementById('retailersAppCard').addEventListener('click', function() {
        document.getElementById('cardSelectionScreen').style.display = 'none';
        document.getElementById('retailersSection').style.display = 'block';
        updateNavigationContext('retailers');
      });
      
      document.getElementById('abcAppCard').addEventListener('click', function() {
        document.getElementById('cardSelectionScreen').style.display = 'none';
        document.getElementById('abcSection').style.display = 'block';
        updateNavigationContext('abc');
      });
      
      document.getElementById('backToCardsBtn').addEventListener('click', function() {
        document.getElementById('retailersSection').style.display = 'none';
        document.getElementById('cardSelectionScreen').style.display = 'block';
        updateNavigationContext('home');
        
        // Reset toggle logs button state if needed
        const ordersLogContainer = document.getElementById('ordersLogContainer');
        const cardsContainer = document.getElementById('cardsContainer');
        const toggleLogsBtn = document.getElementById('toggleLogsBtn');
        
        if (ordersLogContainer.style.display === 'block') {
          ordersLogContainer.style.display = 'none';
          cardsContainer.style.display = 'block';
          toggleLogsBtn.innerHTML = '<span class="icon"><i class="fas fa-list"></i></span><span>Show Logs</span>';
        }
      });
      
      document.getElementById('backToCardsFromAbcBtn').addEventListener('click', function() {
        document.getElementById('abcSection').style.display = 'none';
        document.getElementById('cardSelectionScreen').style.display = 'block';
        updateNavigationContext('home');
      });
      
      document.addEventListener('DOMContentLoaded', () => {
        // Initialize navigation context
        updateNavigationContext('home');
        
        // Get all "navbar-burger" elements
        const navbarBurgers = Array.from(document.querySelectorAll('.navbar-burger'));
        // Get all "navbar-item" elements inside the navbar menu
        const navbarItems = Array.from(document.querySelectorAll('.navbar-menu .navbar-item'));

        // Check if there are any navbar burgers
        if (navbarBurgers.length > 0) {
          // Add a click event to each burger
          navbarBurgers.forEach(burger => {
            burger.addEventListener('click', () => {
              // Get the target from the "data-target" attribute
              const targetId = burger.dataset.target;
              const target = document.getElementById(targetId);
              // Toggle the "is-active" class on both the "navbar-burger" and the "navbar-menu"
              burger.classList.toggle('is-active');
              target.classList.toggle('is-active');
            });
          });
        }

        // Add a click event to each navbar item
        navbarItems.forEach(item => {
          item.addEventListener('click', () => {
            // Check if the burger menu is active
            const navbarBurger = document.querySelector('.navbar-burger');
            const navbarMenu = document.querySelector('.navbar-menu');

            if (navbarBurger.classList.contains('is-active')) {
              // Remove the "is-active" class from both the "navbar-burger" and the "navbar-menu"
              navbarBurger.classList.remove('is-active');
              navbarMenu.classList.remove('is-active');
            }
          });
        });
      });
    </script>
    
    <div id="aperakModal" class="modal modal-full-screen modal-fx-slideTop">
      <div class="modal-content modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title">APERAK</p>
          <button class="modal-button-close delete" aria-label="close"></button>
        </header>
        <section class="modal-card-body">
          <table
            class="table is-bordered is-striped is-narrow is-hoverable is-fullwidth is-small"
            style="width: 100%; font-size: 0.8em"
          >
            <thead>
              <tr>
                <th>MESSAGEDATE</th>
                <th>MESSAGETIME</th>
                <th>MESSAGEORIGIN</th>
                <th>DOCUMENTREFERENCE</th>
                <th>DOCUMENTUID</th>
                <th>SUPPLIERRECEIVERCODE</th>
                <th>DOCUMENTRESPONSE</th>
                <th>DOCUMENTDETAIL</th>
              </tr>
            </thead>
            <tbody id="aperakTable"></tbody>
          </table>
        </section>
        <footer class="modal-card-foot">
          <button class="modal-button-close button is-success">Save changes</button>
          <button class="modal-button-close button">Cancel</button>
        </footer>
      </div>
    </div>
    
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma-modal-fx@1.1.1/dist/css/modal-fx.min.css"
    />
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/bulma-modal-fx@1.1.1/dist/js/modal-fx.min.js"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
    
    <!-- FontAwesome for icons -->
    <script defer src="https://use.fontawesome.com/releases/v5.15.4/js/all.js"></script>
    
    <!-- ABC Module Scripts -->
    <script type="module" src="/js/abc-module.js"></script>
    
    <!-- Chart.js and ABC BI Module Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- Load abc-bi-module.js after all other scripts (Feathers client) are loaded -->
    <script type="module" src="/js/abc-bi-module.js"></script>
    
    <!-- Initialize the ABC BI Dashboard when tab is activated -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Add tab switching event for ABC tabs
        const abcTabs = document.querySelectorAll('#abcTabs li');
        const tabContents = document.querySelectorAll('.tab-content');
        
        abcTabs.forEach(tab => {
          tab.addEventListener('click', function() {
            // Remove active class from all tabs
            abcTabs.forEach(t => t.classList.remove('is-active'));
            
            // Add active class to clicked tab
            this.classList.add('is-active');
            
            // Hide all tab contents
            tabContents.forEach(content => {
              content.style.display = 'none';
            });
            
            // Show selected tab content
            const tabId = this.dataset.tab;
            document.getElementById(tabId + 'Tab').style.display = 'block';
            
            // Initialize BI dashboard if BI tab was selected
            if (tabId === 'bi' && window.abcBI) {
              window.abcBI.initDashboard();
            }
          });
        });
        
        // Setup expandable sections for the report
        const setupExpandableSections = () => {
          const revenueSectionHeader = document.querySelector('#revenuesSection .is-flex');
          const expensesSectionHeader = document.querySelector('#expensesSection .is-flex');
          const revenueSectionContent = document.querySelector('#revenuesSection .section-content');
          const expensesSectionContent = document.querySelector('#expensesSection .section-content');
          
          if (revenueSectionHeader && revenueSectionContent) {
            revenueSectionHeader.addEventListener('click', () => {
              const isExpanded = revenueSectionContent.style.maxHeight !== '0px' && 
                               revenueSectionContent.style.maxHeight !== '';
              const toggleIcon = revenueSectionHeader.querySelector('.toggle-icon');
              
              if (isExpanded) {
                revenueSectionContent.style.maxHeight = '0px';
                toggleIcon.textContent = '+';
              } else {
                revenueSectionContent.style.maxHeight = '2000px';
                toggleIcon.textContent = '-';
              }
            });
          }
          
          if (expensesSectionHeader && expensesSectionContent) {
            expensesSectionHeader.addEventListener('click', () => {
              const isExpanded = expensesSectionContent.style.maxHeight !== '0px' && 
                               expensesSectionContent.style.maxHeight !== '';
              const toggleIcon = expensesSectionHeader.querySelector('.toggle-icon');
              
              if (isExpanded) {
                expensesSectionContent.style.maxHeight = '0px';
                toggleIcon.textContent = '+';
              } else {
                expensesSectionContent.style.maxHeight = '2000px';
                toggleIcon.textContent = '-';
              }
            });
          }
        };
        
        // Add a CSS keyframe animation for the spinner
        const style = document.createElement('style');
        style.textContent = `
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
          
          .box.is-loading {
            position: relative;
          }
          .box.is-loading::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1;
          }
          .box.is-loading::before {
            content: "";
            position: absolute;
            top: calc(50% - 1.5rem);
            left: calc(50% - 1.5rem);
            width: 3rem;
            height: 3rem;
            border: 0.25rem solid #dbdbdb;
            border-radius: 50%;
            border-right-color: #3298dc;
            animation: spinAround 500ms infinite linear;
            z-index: 2;
          }
        `;
        document.head.appendChild(style);
        
        // Initialize expandable sections when BI tab is activated
        document.querySelector('#abcTabs [data-tab="bi"]').addEventListener('click', function() {
          // Wait for the content to be fully loaded before setting up sections
          setTimeout(() => {
            setupExpandableSections();
          }, 100);
        });
      });
    </script>
  </body>
</html>